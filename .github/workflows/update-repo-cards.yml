name: Update Repository List in README

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC

permissions:
  contents: write

jobs:
  update-repo-list:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate repository list
        run: |
          USER="${{ github.repository_owner }}"
          
          # Fetch all repos
          curl -s "https://api.github.com/users/$USER/repos?per_page=100&sort=updated" > repos.json
          
          # Start generating the list
          echo "" > repo_list.md
          echo "| Repository | Description | Stars | Forks | Language |" >> repo_list.md
          echo "|------------|-------------|-------|-------|----------|" >> repo_list.md
          
          # Loop through repos and create table rows
          jq -r '.[] | select(.fork == false) | "| [\(.name)](\(.html_url)) | \(.description // "No description") | ![\(.stargazers_count)](https://img.shields.io/github/stars/'$USER'/\(.name)?style=social) | ![Forks](https://img.shields.io/github/forks/'$USER'/\(.name)?style=flat-square) | \(.language // "N/A") |"' repos.json >> repo_list.md

      - name: Update README
        run: |
          # Define markers
          START_MARKER="<!-- REPO-LIST:START -->"
          END_MARKER="<!-- REPO-LIST:END -->"
          
          # Use awk to replace content between markers
          awk -v start="$START_MARKER" -v end="$END_MARKER" '
            BEGIN {p=1}
            $0 ~ start {print; system("cat repo_list.md"); p=0}
            $0 ~ end {p=1}
            p' README.md > README_new.md
          
          mv README_new.md README.md

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "üìù Update repository list" || echo "No changes to commit"
          git push
